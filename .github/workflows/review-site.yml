name: Build & deploy review site
on:
  pull_request:
  push:
    branches:
      - master

jobs:
  review-site:
    name: Build & deploy review site
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
      - name: Find the push source branch name
        if: ${{ github.event_name != 'pull_request' }}
        run: echo "::set-env name=AZ_TRIMMED_REF::${GITHUB_REF#refs/*/}"
      - name: Find the pull request source branch name
        if: ${{ github.event_name == 'pull_request' }}
        run: echo "::set-env name=AZ_TRIMMED_REF::${GITHUB_HEAD_REF}"
      - name: Build variables
        run: |
          echo "::set-env name=AZ_BOOTSTRAP_SOURCE_DIR::arizona-bootstrap-src"
          labelledimage=$(scripts/build-container.sh | grep 'ImageID=')
          echo "::set-env name=AZ_DOCKER_IMAGE::${labelledimage#ImageID=}"
          echo "::set-env name=AZ_REVIEW_BASEURL::/bootstrap/${AZ_TRIMMED_REF}" 
      - name: Build review site artifact
        run: |
          docker run --rm -e "AZ_SITE_BASE_URL=$AZ_REVIEW_BASEURL" -v $(pwd):/$AZ_BOOTSTRAP_SOURCE_DIR $AZ_DOCKER_IMAGE expose-review-site
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@b77dc228388218453070969c00c26dc392ecb114
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2
      - name: Deploy review site artifact to S3 + CloudFront
        run: |
          aws s3 sync --delete _site/ s3://${{ secrets.REVIEW_BUCKET }}${AZ_REVIEW_BASEURL}/
          aws cloudfront create-invalidation --distribution-id ${{ secrets.REVIEW_CDN }} --paths ${AZ_REVIEW_BASEURL}/*
      - name: Display review site URL
        # TODO: replace with step that publishes link to review site on PR.
        run: |
          echo "Review site deployed to https://review.digital.arizona.edu${AZ_REVIEW_BASEURL}"
